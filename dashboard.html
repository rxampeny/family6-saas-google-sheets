<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Family6 SaaS</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="dashboard-logo">
                <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="40" height="40" rx="10" fill="url(#gradient2)"/>
                    <path d="M12 20L18 26L28 14" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    <defs>
                        <linearGradient id="gradient2" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#6366F1"/>
                            <stop offset="1" stop-color="#4F46E5"/>
                        </linearGradient>
                    </defs>
                </svg>
                Family6
            </div>

            <div class="dashboard-user">
                <span class="user-email" id="userEmail">usuario@email.com</span>
                <div class="user-avatar" id="userAvatar">U</div>
                <button class="btn btn-secondary btn-sm" id="logoutBtn">Cerrar sesion</button>
            </div>
        </header>

        <!-- Content -->
        <div class="dashboard-content">
            <!-- Sidebar -->
            <aside class="dashboard-sidebar">
                <nav class="sidebar-nav">
                    <div class="sidebar-section">
                        <span class="sidebar-section-title">Menu</span>
                        <a href="dashboard.html" class="sidebar-link active">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                            Dashboard
                        </a>
                        <a href="conversaciones.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            Conversaciones
                        </a>
                        <a href="analiticas.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="20" x2="12" y2="10"/>
                                <line x1="18" y1="20" x2="18" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="16"/>
                            </svg>
                            Analiticas
                        </a>
                        <a href="configuracion.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                            Configuracion
                        </a>
                    </div>
                </nav>

                <div class="sidebar-footer">
                    <a href="#" class="sidebar-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        Ayuda
                    </a>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="dashboard-main">
                <h1>Bienvenido a tu Dashboard</h1>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <span class="dashboard-card-title">Total Mensajes</span>
                            <div class="dashboard-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="dashboard-card-value" id="statTotalMessages">-</div>
                        <div class="dashboard-card-change" id="statMessagesDetail">Cargando...</div>
                    </div>

                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <span class="dashboard-card-title">Conversaciones</span>
                            <div class="dashboard-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                            </div>
                        </div>
                        <div class="dashboard-card-value" id="statConversations">-</div>
                        <div class="dashboard-card-change" id="statConversationsDetail">Cargando...</div>
                    </div>

                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <span class="dashboard-card-title">Mensajes Usuario</span>
                            <div class="dashboard-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                            </div>
                        </div>
                        <div class="dashboard-card-value" id="statHumanMessages">-</div>
                        <div class="dashboard-card-change" id="statHumanDetail">Cargando...</div>
                    </div>

                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <span class="dashboard-card-title">Respuestas IA</span>
                            <div class="dashboard-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="9" y1="9" x2="15" y2="9"/>
                                    <line x1="9" y1="15" x2="15" y2="15"/>
                                </svg>
                            </div>
                        </div>
                        <div class="dashboard-card-value" id="statAiMessages">-</div>
                        <div class="dashboard-card-change" id="statAiDetail">Cargando...</div>
                    </div>
                </div>

                <div class="dashboard-card mt-8">
                    <h3 style="margin-bottom: var(--spacing-4);">Actividad reciente</h3>
                    <div id="recentActivity">
                        <p class="text-muted">Cargando actividad...</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Chat Widget -->
        <div class="chat-widget" id="chatWidget">
            <div class="chat-window">
                <div class="chat-header">
                    <h3>Asistente IA</h3>
                    <p>Preguntame lo que necesites</p>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="chat-welcome">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <h4>Hola! Como puedo ayudarte?</h4>
                        <p>Escribe tu mensaje para comenzar una conversacion.</p>
                    </div>
                </div>

                <div class="chat-input-area">
                    <input
                        type="text"
                        class="chat-input"
                        id="chatInput"
                        placeholder="Escribe tu mensaje..."
                        autocomplete="off"
                    >
                    <button class="chat-send" id="chatSend" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                </div>
            </div>

            <button class="chat-toggle" id="chatToggle">
                <svg class="chat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <svg class="close-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script type="module">
        import { signOut, getUser, onAuthStateChange } from './js/auth.js';
        import { protectPage } from './js/router.js';
        import { initChat } from './js/chat.js';
        import { showToast } from './js/ui.js';
        import { getChatStats } from './js/api.js';
        import CONFIG from './js/config.js';

        /**
         * Format date for display
         */
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) {
                return 'Hoy ' + date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            } else if (days === 1) {
                return 'Ayer';
            } else if (days < 7) {
                return date.toLocaleDateString('es-ES', { weekday: 'long' });
            } else {
                return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
            }
        }

        /**
         * Load and display dashboard statistics from Google Sheets
         */
        async function loadDashboardStats() {
            const { data, error } = await getChatStats();

            if (error || !data) {
                // Show placeholder on error
                document.getElementById('statTotalMessages').textContent = '0';
                document.getElementById('statMessagesDetail').textContent = 'Usa el chat para comenzar';
                document.getElementById('statConversations').textContent = '0';
                document.getElementById('statConversationsDetail').textContent = 'Sesiones de chat';
                document.getElementById('statHumanMessages').textContent = '0';
                document.getElementById('statHumanDetail').textContent = 'Tus mensajes';
                document.getElementById('statAiMessages').textContent = '0';
                document.getElementById('statAiDetail').textContent = 'Respuestas del asistente';
                document.getElementById('recentActivity').innerHTML = '<p class="text-muted">Usa el chat para comenzar a conversar con el asistente.</p>';
                return;
            }

            const stats = data.stats || {};

            // Update stat cards
            document.getElementById('statTotalMessages').textContent = stats.totalMessages || 0;
            document.getElementById('statMessagesDetail').textContent = stats.totalMessages > 0 ? 'Mensajes totales' : 'Usa el chat para comenzar';

            document.getElementById('statConversations').textContent = stats.totalSessions || 0;
            document.getElementById('statConversationsDetail').textContent = 'Sesiones de chat';

            document.getElementById('statHumanMessages').textContent = stats.humanMessages || 0;
            document.getElementById('statHumanDetail').textContent = 'Tus mensajes';

            document.getElementById('statAiMessages').textContent = stats.aiMessages || 0;
            document.getElementById('statAiDetail').textContent = 'Respuestas del asistente';

            // Update recent activity
            const recentDiv = document.getElementById('recentActivity');
            if (stats.totalMessages > 0) {
                recentDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-gray-100);">
                            <span>Primera conversacion</span>
                            <span class="text-muted">${formatDate(stats.firstMessageDate)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-gray-100);">
                            <span>Ultima actividad</span>
                            <span class="text-muted">${formatDate(stats.lastMessageDate)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <span>Promedio por sesion</span>
                            <span class="text-muted">${stats.totalSessions > 0 ? Math.round(stats.totalMessages / stats.totalSessions) : 0} mensajes</span>
                        </div>
                    </div>
                `;
            } else {
                recentDiv.innerHTML = '<p class="text-muted">Usa el chat para comenzar a conversar con el asistente.</p>';
            }
        }

        // Protect the page - redirect to login if not authenticated
        protectPage(
            async (session) => {
                // User is authenticated, initialize the dashboard
                const { data } = await getUser();
                const user = data?.user;

                if (user) {
                    // Update UI with user info
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                }

                // Load real stats from Google Sheets
                await loadDashboardStats();

                // Initialize chat
                initChat(user);

                // Show dashboard
                document.querySelector('.dashboard-layout').style.opacity = '1';
            },
            () => {
                // User is not authenticated, redirect handled by protectPage
            }
        );

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            const { error } = await signOut();

            if (error) {
                showToast('Error al cerrar sesion', 'error');
                return;
            }

            showToast('Sesion cerrada', 'success');
            setTimeout(() => {
                window.location.href = CONFIG.ROUTES.LOGIN;
            }, 1000);
        });

        // Chat toggle
        const chatWidget = document.getElementById('chatWidget');
        const chatToggle = document.getElementById('chatToggle');
        const chatInput = document.getElementById('chatInput');

        chatToggle.addEventListener('click', () => {
            chatWidget.classList.toggle('open');
            if (chatWidget.classList.contains('open')) {
                chatInput.focus();
            }
        });

        // Listen for auth state changes
        onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                window.location.href = CONFIG.ROUTES.LOGIN;
            }
        });
    </script>
</body>
</html>
